<!DOCTYPE html>
<html ng-app="ionicApp">
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="initial-scale=1, maximum-scale=1, user-scalable=no, width=device-width" />
		<title>My Gateway</title>
		<link href="//code.ionicframework.com/1.0.0-beta.13/css/ionic.css" rel="stylesheet">
		<script src="//api.easylink.io/bower_components/ionic/js/ionic.bundle.min.js"></script>
		<script src="http://api.easylink.io/assets/js/mqttws31.js"></script>
		<script src="./js/jquery-2.1.3.js"></script>
		<!-- ===================================================================================================================== -->
		<script type="text/javascript" charset="UTF-8">
			// 从url中获取某个参数的值
			function getParameterByName(name) {
				var match = RegExp('[?&]' + name + '=([^&]*)').exec(window.location.search);
				return match && decodeURIComponent(match[1].replace(/\+/g, ' '));
			}

			// 得到设备ID
			var my_device_id = getParameterByName('device_id');
			console.log(my_device_id);
			// 如果设备ID不为空，则执行连接MQTT的操作
			if (my_device_id !== null) {
				ez_connect(my_device_id);
			}

			// 连接MQTT服务
			function ez_connect(device_id) {
				// 获取access_token
				// access_token是公众号的全局唯一票据，公众号调用各接口时都需使用access_token。
				// 正常情况下access_token有效期为7200秒，重复获取将导致上次获取的access_token失效
				var access_token = getParameterByName('access_token');

				// websocket连接
				// wsbroker:host
				// wsport:端口 默认1983
				// Client-ID ： v1_web_[MAC]  //版本号_app_手机MAC(必须是12位小写)
				var wsbroker = "api.easylink.io";
				//mqtt websocket enabled broker
				var wsport = 1983;
				// port for above
				var client = new Paho.MQTT.Client(wsbroker, wsport, "v1-web-" + parseInt(Math.random() * 1000000, 12));

				// 基本参数配置
				// 连接丢失所对应的callback函数
				client.onConnectionLost = onConnectionLost;
				// 消息到达所对应的callback函数
				client.onMessageArrived = onMessageArrived;
				// 连接成功所对应的callback函数
				client.connect({
					onSuccess : onConnect
				});

				// 连接成功
				function onConnect() {
					var subtopic = device_id + '/out/#';
					// Once a connection has been made, make a subscription and send a message.
					// 向某个通道发送指令
					// topic：通道
					// commond：指令
					client.publish = function(topic, commond) {
						console.log("现在执行-->:" + commond);
						message = new Paho.MQTT.Message(commond);
						message.destinationName = topic;
						client.send(message);
					};
					console.log("Have Connect");
					console.log("ZigBee Devices List:");
					zcb_devices();

					client.subscribe(subtopic, {
						qos : 0
					});
				}

				// 连接丢失
				function onConnectionLost(responseObject) {
					if (responseObject.errorCode !== 0)
						console.log("onConnectionLost:" + responseObject.errorMessage);
				}

				// 消息到达
				function onMessageArrived(message) {
					console.log(message.payloadString);

					var msgjson = $.parseJSON(message.payloadString);
					console.log(msgjson);
					if (msgjson.hasOwnProperty("devicelist")) {

						console.log("1");
						var ddd = msgjson.devicelist;
						console.log(ddd);
						console.log("2");

						items = [];
						//会导致连接丢失
						for (var p in ddd)//遍历设备对象
						{
							console.log(ddd[p]);
							items.push({
								'alias' : 1,
								'device_id' : my_device_id,
								'zigbee_device_id' : ddd[p].Zigbee_deviceID,
								'zigbee_device_address_H' : ddd[p].Zigbee_longAddress_H,
								'zigbee_device_address_L' : ddd[p].Zigbee_longAddress_L,
								'zigbee_device_short_address' : ddd[p].Zigbee_shortAddress,
								'state' : 1
							});

						}
						console.log(items);
						reloadPage();
						//log devicelist
					} else {

					}

				}

				//led on
				function led_on() {
					var topic = device_id + '/in/write';
					var commond = '{"11":"' + 'on' + '"}';
					console.log("led_on");
					client.publish(topic, commond);
				}

				// document.querySelector('#led_on').addEventListener('touchstart', led_on);
				document.querySelector('#led_on').addEventListener('click', led_on);

				//led off
				function led_off() {
					var topic = device_id + '/in/write';
					var commond = '{"11":"' + 'off' + '"}';
					client.publish(topic, commond);
				}

				// document.querySelector('#led_off').addEventListener('touchstart', led_off);
				document.querySelector('#led_off').addEventListener('click', led_off);

				//初始化 ZigBee 网络
				function zcb_factorynew() {
					var topic = device_id + '/in/write';
					var commond = '{"11":"' + 'factorynew' + '"}';
					client.publish(topic, commond);
				}

				// document.querySelector('#zcb_init').addEventListener('touchstart', zcb_init);
				document.querySelector('#zcb_factorynew').addEventListener('click', zcb_factorynew);

				//设置 ZigBee 网络 permit join
				function zcb_permitjoin() {
					var topic = device_id + '/in/write';
					var commond = '{"11":"' + 'permit' + '"}';
					client.publish(topic, commond);
				}

				// document.querySelector('#zcb_permitjoin').addEventListener('touchstart', zcb_permitjoin);
				document.querySelector('#zcb_permitjoin').addEventListener('click', zcb_permitjoin);

				function zcb_devices() {
					var topic = device_id + '/in/write';
					var commond = '{"11":"' + 'nodes' + '"}';
					client.publish(topic, commond);
				}

			}

			// 日志打印在页面的部分
			console.log = ( function(old_funct) {
					return function(text) {
						old_funct(text);
					};
				}(console.log.bind(console)));
			console.error = console.debug = console.info = console.log;
		
		

			var device_list = [];
			//设备列表
			var deviceLists = getParameterByName('device_list');

			//
			angular.module('ionicApp', ['ionic']).controller('MyCtrl', function($scope, $ionicPopup, $ionicListDelegate, $http) {
				$scope.items = device_list;
				$scope.access_token = access_token;

				$scope.data = {
					showDelete : false
				};

				$scope.listCanSwipe = true;
				$scope.showPopup = function(item) {
					var index = $scope.items.indexOf(item);
					$scope.data = {

					};

					// An elaborate, custom popup
					var myPopup = $ionicPopup.show({
						template : '<input type="text" ng-model="data.alias">',
						title : '',
						subTitle : '修改名称',
						scope : $scope,
						buttons : [{
							text : 'Cancel'
						}, {
							text : '<b>Save</b>',
							type : 'button-positive',
							onTap : function(e) {
								if (!$scope.data.alias) {
									e.preventDefault();
								} else {
									$http.post('http://api.easylink.io/v1/device/modify', {
										device_id : item.device_id,
										alias : $scope.data.alias
									}, {
										headers : {
											'AUTHORIZATION' : "token " + access_token
										}
									}).success(function(data) {
										$scope.items[index].alias = $scope.data.alias;
										$ionicListDelegate.closeOptionButtons();

									}).error(function(data) {
										alert(data.error.message);
										return;
									});
								}
							}
						}]
					});
				};

				//刷新页面
				$scope.reloadPage = function() {
					//重新载入页面，刷新设备列表
					//1.发送设备列表请求

					//2.接收设备列表
					//3.将设备列表信息 push 到 items 中(items会被显示到ion-content中)
					console.log("refresh device");

					$http.post('http://api.easylink.io/v1/device/devices', null, {
						headers : {
							'AUTHORIZATION' : "token " + access_token
						}
					}).success(function(data) {

						console.log("post success");
						console.log(items);

						$scope.items = [];
						$scope.items = items;

						console.log($scope.items);

					}).error(function(data) {
						alert(data.error.message);
						return;
					});

				};

			});
			
		</script>

	</head>

	<body ng-controller="MyCtrl">
		<ion-header-bar class="bar bar-header bar-assertive">
			<h1 class="title" >Device List</h1>
			<div class="buttons">
				<button class="button ion-refresh" ng-click="reloadPage()"></button>
			</div>
		</ion-header-bar>

		<ion-content >
			<ion-list can-swipe="listCanSwipe"  show-delete="data.showDelete" show-reorder="data.showReorder">
				<ion-item ng-repeat="item in items"
				item="item"
				href="{{ item.zigbee_device_id }}.html?device_id={{ item.device_id }}&access_token={{ access_token }}&alias={{ item.alias }}&zigbee_device_id={{ item.zigbee_device_id }}&zigbee_device_address_H={{ item.zigbee_device_address_H }}&zigbee_device_address_L={{ item.zigbee_device_address_L }}&zigbee_device_short_address={{ item.zigbee_device_short_address }}" class="item-remove-animate">
					<i ng-if="item.state==1" class="icon ion-record positive" ></i><i ng-if="item.state==0" class="icon ion-record assertive" ></i> {{ item.alias }}
					<br>
					<span class="item-note">ID : {{ item.device_id }}</span>
					<ion-option-button class="button-assertive"
					ng-click="showPopup(item)">
						Edit
					</ion-option-button>
				</ion-item>
			</ion-list>
		</ion-content>

		<div class="bar-footer" style="bottom:0;position:absolute;width:100%">
			<div class="button-bar">
				<a class="button" style="background:white; color:black" id="led_on">On</a>
				<a class="button" style="background:black; color:white" id="led_off">Off</a>
			</div>
			<div class="button-bar">
				<a class="button" style="background:white; color:black" id="zcb_factorynew">Factory New GateWay</a>
				<a class="button" style="background:black; color:white" id="zcb_permitjoin">Permit Join</a>
			</div>
		</div>

	</body>
</html>
